<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>一起旅行</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#8B7E6A">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#FAF9F6;--card:#FFF;--accent:#8B7E6A;--text:#2c2c2c;--soft:#B8A89A;--border:#e0e0e0}
    body.dark{--bg:#000;--card:#1a1a1a;--accent:#D4C2A9;--text:#f0f0f0;--soft:#B89A7A;--border:#333}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:'Noto Serif TC',serif;transition:all .3s}
    header{background:var(--accent);color:white;padding:20px;position:fixed;top:0;width:100%;z-index:1000;text-align:center}
    header h1{font-family:'ZCOOL XiaoWei',serif;font-size:28px;letter-spacing:3px}
    .moon{position:absolute;top:20px;right:20px;font-size:26px;cursor:pointer}
    .navbar{position:fixed;top:70px;left:0;right:0;background:var(--card);border-bottom:1px solid var(--border);display:flex;z-index:999}
    .navbar button{flex:1;padding:16px;font-size:14px;border:none;background:none;color:var(--text);opacity:0.7}
    .navbar button.active{opacity:1;color:var(--accent);font-weight:700;border-bottom:3px solid var(--accent)}
    main{padding:140px 15px 80px;max-width:900px;margin:0 auto}
    .card{background:var(--card);border-radius:22px;padding:32px;margin:20px 0;box-shadow:0 12px 35px rgba(0,0,0,0.12)}
    input,select,textarea{width:100%;padding:16px;margin:12px 0;border:1px solid var(--border);border-radius:16px;background:var(--card);color:var(--text);font-size:17px}
    button{background:var(--accent);color:white;padding:18px;border:none;border-radius:20px;font-size:18px;cursor:pointer;width:90%;margin:20px auto;display:block}
    button.green{background:#4caf50}
    .trip-item{background:var(--card);padding:20px;border-radius:16px;margin:15px 0;box-shadow:0 6px 20px rgba(0,0,0,0.08);cursor:pointer}
    .avatar{width:40px;height:40px;border-radius:50%;display:inline-block;text-align:center;line-height:40px;color:white;font-weight:bold}
    .expense-row{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)}
    #perPerson{font-size:28px;font-weight:bold;text-align:center;margin:30px 0;color:#4caf50}
  </style>
</head>
<body>

<header>
  <h1>一起旅行</h1>
  <div class="moon" onclick="document.body.classList.toggle('dark')">Moon</div>
</header>

<div class="navbar">
  <button class="active" onclick="showTab(0)">建立行程</button>
  <button onclick="showTab(1)">我的行程</button>
  <button onclick="showTab(2)">預算</button>
</div>

<main>
  <!-- 0. 建立行程 -->
  <div class="page active">
    <div class="card">
      <h2>建立全新旅行行程</h2>
      <input type="text" id="countries" placeholder="旅行國家" value="日本">
      <input type="text" id="tripName" placeholder="行程名稱（如：2026 日本自駕）" value="2026 日本自駕">
      <input type="number" id="peopleCount" placeholder="人數" value="4">
      <label>去程日期</label>
      <input type="date" id="dateStart">
      <label>回程日期</label>
      <input type="date" id="dateEnd">
      <button class="green" onclick="createNewTrip()">建立行程</button>
    </div>
  </div>

  <!-- 1. 我的行程列表 -->
  <div class="page">
    <div class="card">
      <h2>我的行程</h2>
      <input type="text" id="searchCode" placeholder="輸入6碼加入朋友行程" maxlength="6" style="letter-spacing:8px;font-size:20px;text-align:center">
      <button onclick="joinByCode()" style="width:auto;padding:12px 30px">加入</button>
      <div id="tripList"></div>
    </div>
  </div>

  <!-- 2. 預算總覽（會在點行程後顯示） -->
  <div class="page">
    <div class="card" id="budgetDetail" style="display:none">
      <h2 id="budgetTitle">行程預算</h2>
      <div id="expenseList"></div>
      <div style="margin:30px 0;padding:20px;background:#f0f0f0;border-radius:16px">
        <div style="font-size:20px;margin:10px 0">總額：<span id="totalAll">0</span> HKD</div>
        <div id="perPerson">每人應付：0 HKD</div>
      </div>
    </div>
  </div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = { databaseURL: "https://travel-together-2025-default-rtdb.asia-southeast1.firebasedatabase.app" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const userId = localStorage.getItem('userId') || Date.now().toString(36);
  localStorage.setItem('userId', userId);
  const myTripsRef = db.ref('users/'+userId+'/trips');
  let currentTripId = null;
  let currentTripData = null;

  const pages = document.querySelectorAll('.page');
  function showTab(n){
    pages.forEach((p,i)=>p.classList.toggle('active', i===n));
    document.querySelectorAll('.navbar button').forEach((b,i)=>b.classList.toggle('active', i===n));
  }

  // 建立新行程
  function createNewTrip(){
    const name = document.getElementById('tripName').value || '未命名行程';
    const start = document.getElementById('dateStart').value;
    const end = document.getElementById('dateEnd').value;
    if(!start || !end) return alert("請選擇日期！");
    
    const tripId = Date.now().toString();
    const tripRef = db.ref('trips/'+tripId);
    const newTrip = {
      name, start, end,
      people: parseInt(document.getElementById('peopleCount').value)||4,
      owner: userId,
      members: {[userId]: true},
      expenses: [],
      created: Date.now()
    };
    
    tripRef.set(newTrip).then(()=>{
      myTripsRef.child(tripId).set(true);
      openTrip(tripId, newTrip);
    });
  }

  // 加入朋友行程
  function joinByCode(){
    const code = document.getElementById('searchCode').value.toUpperCase();
    if(code.length!==6) return alert("請輸入6碼");
    // 實際專案可用 code → tripId 映射，這裡簡化直接用 tripId
    const tripRef = db.ref('trips/'+code);
    tripRef.once('value', snap=>{
      if(snap.exists()){
        myTripsRef.child(code).set(true);
        openTrip(code, snap.val());
      } else alert("找不到此行程");
    });
  }

  // 開啟行程
  function openTrip(tripId, data){
    currentTripId = tripId;
    currentTripData = data;
    document.getElementById('budgetTitle').textContent = data.name + ' 預算';
    document.getElementById('budgetDetail').style.display = 'block';
    showTab(2);
    loadExpenses();
  }

  // 載入所有我的行程
  myTripsRef.on('value', snap=>{
    const trips = snap.val()||{};
    let html = '';
    Object.keys(trips).forEach(id=>{
      db.ref('trips/'+id).once('value', s=>{
        const t = s.val();
        if(t){
          const color = '#'+Math.floor(Math.random()*16777215).toString(16);
          html += `<div class="trip-item" onclick="openTrip('${id}', ${JSON.stringify(t).replace(/'/g,"\\'")})">
            <div style="background:${color}" class="avatar">${t.name[0]}</div>
            <div style="margin-left:15px;flex:1">
              <strong>${t.name}</strong><br>
              <small>${t.start} 至 ${t.end} • ${t.people}人</small>
            </div>
          </div>`;
          document.getElementById('tripList').innerHTML = html;
        }
      });
    });
  });

  // 載入預算
  function loadExpenses(){
    if(!currentTripId) return;
    db.ref('trips/'+currentTripId+'/expenses').on('value', snap=>{
      const exps = snap.val()||[];
      let totalHKD = 0;
      let html = '';
      exps.forEach(e=>{
        const amountHKD = e.currency==='JPY'? e.amount/19.6 : e.currency==='TWD'? e.amount/4.11 : e.amount;
        totalHKD += amountHKD;
        html += `<div class="expense-row">
          <div>${e.item}</div>
          <div>${e.amount} ${e.currency}</div>
        </div>`;
      });
      document.getElementById('expenseList').innerHTML = html || '<p style="text-align:center;color:#999;padding:40px">還沒有花費紀錄</p>';
      const per = (totalHKD / currentTripData.people).toFixed(0);
      document.getElementById('totalAll').textContent = totalHKD.toFixed(0);
      document.getElementById('perPerson').textContent = `每人應付：${per} HKD`;
    });
  }

  // 預設今天日期
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('dateStart').value = today;
  document.getElementById('dateEnd').value = new Date(Date.now()+14*86400000).toISOString().split('T')[0];
</script>
</body>
</html>
