<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>一起旅行・日本自駕版</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#8B7E6A">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#FAF9F6;--card:#FFF;--accent:#8B7E6A;--text:#3D3D3D;--soft:#B8A89A}
    body.dark{--bg:#1F1F1F;--card:#2C2C2C;--accent:#D4C2A9;--text:#E8E8E8;--soft:#A89A8B}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:'Noto Serif TC',serif;font-size:16px;line-height:1.6;min-height:100vh}
    header{background:var(--accent);color:white;padding:20px;text-align:center;position:fixed;width:100%;top:0;z-index:1000}
    header h1{font-family:'ZCOOL XiaoWei',serif;font-size:28px;letter-spacing:2px}
    nav{display:flex;justify-content:center;gap:15px;margin-top:10px;flex-wrap:wrap}
    nav a{color:white;text-decoration:none;font-size:16px;padding:10px 16px;border-radius:20px}
    nav a.active{background:rgba(255,255,255,0.2)}
    main{padding-top:100px;padding-bottom:60px;max-width:900px;margin:0 auto;padding:15px}
    .page{display:none}
    .page.active{display:block;animation:fade 0.5s}
    @keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1}}
    .card{background:var(--card);padding:30px;margin:20px 0;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.1)}
    h2{font-family:'ZCOOL XiaoWei',serif;color:var(--accent);font-size:26px;text-align:center;margin-bottom:20px}
    input,button{width:100%;padding:16px;margin:12px 0;border:none;border-radius:16px;font-size:16px}
    input{background:#f5f5f5;text-align:center}
    body.dark input{background:#333;color:white}
    button{background:var(--accent);color:white;font-weight:600;cursor:pointer;transition:0.3s}
    button:hover{background:var(--soft)}
    .btn-small{padding:12px 24px;width:auto;display:inline-block;margin:6px;font-size:15px;border-radius:20px}
    .room-code{font-size:32px;font-weight:bold;color:var(--accent);letter-spacing:6px;margin:20px 0;text-align:center}
    #itineraryList{margin:30px 0}
    .itinerary-item{background:white;padding:20px;margin:12px 0;border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,0.1);cursor:move;font-size:16px;display:flex;align-items:center}
    body.dark .itinerary-item{background:#333}
    .drag-handle{font-size:24px;margin-right:12px;color:#ccc;cursor:grab}
    #locationMap{height:400px;margin:30px 0;border-radius:16px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,0.15);background:#f0f0f0;text-align:center;line-height:400px;font-size:18px}
    .comments{ margin:20px 0; padding:15px; background:#f8f8f8; border-radius:12px; }
    body.dark .comments{ background:#333; }
    .comment-item{ padding:10px; margin:8px 0; border-left:3px solid var(--accent); padding-left:12px; font-size:14px; }
    .online{font-size:14px;text-align:center;margin:15px 0;color:var(--soft)}
  </style>
</head>
<body>

<header>
  <h1>一起旅行</h1>
  <nav>
    <a href="#" class="active" onclick="showPage('home')">首頁</a>
    <a href="#" onclick="showPage('plan')">自駕行程</a>
    <a href="#" onclick="showPage('share')">朋友分享</a>
  </nav>
</header>

<main>
  <!-- 首頁：Threads 貼文範例 -->
  <section id="home" class="page active">
    <div class="card">
      <h2>像這樣規劃你的日本自駕</h2>
      <p style="text-align:center;font-style:italic;margin:20px 0;font-size:15px">靈感來自 Threads 用戶 ciao_kitchen 的分享</p>
      <div style="background:#f0f0f0;padding:20px;border-radius:12px;margin:20px 0;font-size:15px">
        <p>"我也試了把明年的日本自駕行程丟進 Gemini 3 ... 結果生成的工具遠遠超越我的期待！直接部署到手機上超實用～全程是 Gemini 被我脅迫手把手教，一個週六的早晨從無到有生出來 + 部署完成 + 優化。AI Studio 邊寫邊上傳到 GitHub，Hosting 自動偵測版本、自動部署，圖片素材都是 Nano Banana Pro 生的，資料庫串在 Firebase 同步。最後用 Shortcut 掛個 icon 就是個臨時 App。這一切居然都是免費的。剛剛把工具傳給家人，大家都興奮起來了！這種週拋式客製 App 好方便啊～J 人的護身符。"</p>
      </div>
      <p style="text-align:center;font-size:18px;margin:30px 0">現在輪到你了！</p>
      <div style="text-align:center">
        <button class="btn-small" onclick="showPage('plan')">開始自駕規劃</button>
        <button class="btn-small" onclick="showPage('share')">加入朋友分享</button>
        <button class="btn-small" onclick="document.body.classList.toggle('dark')">夜間模式</button>
      </div>
    </div>
  </section>

  <!-- 自駕行程頁 -->
  <section id="plan" class="page">
    <div class="card">
      <h2>你的日本自駕行程</h2>
      <div class="room-code" id="roomCode">自動產生中...</div>
      <p class="online">目前 <span id="onlineNum">1</span> 人編輯中</p>
      <input type="text" id="routeInput" placeholder="路線：東京 → 箱根 → 京都" oninput="saveSync()">
      <div style="text-align:center">
        <button onclick="aiGenerate()">AI 生成自駕路線</button>
        <button class="btn-small" onclick="addBudget()">加預算計算</button>
      </div>
      <div id="itineraryList"></div>
      <div id="locationMap">點擊生成路線後，點擊下方連結開啟 Google Maps</div>
      <a id="mapLink" href="#" target="_blank" style="display:none;font-size:18px;text-align:center;color:var(--accent);text-decoration:none">開啟 Google Maps 導航</a>
      
      <!-- 留言板（Threads 留言靈感） -->
      <h2 style="margin-top:30px">留言板（像 Threads 一樣討論）</h2>
      <div class="comments">
        <input type="text" id="commentInput" placeholder="分享想法：這條路線怎麼樣？" oninput="saveComment()">
        <div id="commentsList"></div>
      </div>
    </div>
  </section>

  <!-- 朋友分享頁 -->
  <section id="share" class="page">
    <div class="card">
      <h2>加入朋友的自駕分享</h2>
      <input type="text" id="shareCode" placeholder="輸入 6 碼分享碼" style="font-size:18px;letter-spacing:4px">
      <button onclick="joinShare()">加入</button>
      <p id="shareStatus" style="text-align:center;margin:20px 0"></p>
      <div id="sharedContent" style="display:none">
        <div class="room-code" id="sharedCode"></div>
        <p class="online">目前 <span id="sharedOnline">0</span> 人編輯中</p>
        <div id="sharedList"></div>
        <div id="sharedMap">路線同步中...</div>
        <div id="sharedComments"></div>
      </div>
    </div>
  </section>
</main>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = { databaseURL: "https://travel-together-2025-default-rtdb.asia-southeast1.firebasedatabase.app" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentRoomId = null;
  let userId = Math.random().toString(36).substr(2,9);

  function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
    document.querySelector(`nav a[onclick="showPage('${id}')"]`).classList.add('active');
    if (id === 'plan') initRoom();
  }

  function initRoom() {
    currentRoomId = Math.random().toString(36).substring(2,8).toUpperCase();
    document.getElementById('roomCode').textContent = currentRoomId;
    setupSync(currentRoomId, 'plan');
  }

  function joinShare() {
    const code = document.getElementById('shareCode').value.trim().toUpperCase();
    if (code.length !== 6) return document.getElementById('shareStatus').innerHTML = '<p style="color:red">碼要 6 碼！</p>';
    currentRoomId = code;
    document.getElementById('sharedCode').textContent = code;
    document.getElementById('shareStatus').innerHTML = '<p style="color:green">加入成功！</p>';
    document.getElementById('sharedContent').style.display = 'block';
    setupSync(code, 'share');
  }

  function setupSync(room, mode) {
    const roomRef = db.ref('rooms/' + room);
    const listId = mode === 'plan' ? 'itineraryList' : 'sharedList';
    const mapId = mode === 'plan' ? 'locationMap' : 'sharedMap';
    const commentId = mode === 'plan' ? 'commentsList' : 'sharedComments';
    const onlineId = mode === 'plan' ? 'onlineNum' : 'sharedOnline';

    // 同步行程
    roomRef.child('itinerary').on('value', snap => {
      const items = snap.val() || [];
      const list = document.getElementById(listId);
      list.innerHTML = '';
      items.forEach(text => {
        const div = document.createElement('div');
        div.className = 'itinerary-item';
        div.innerHTML = `<span class="drag-handle">⋮⋮</span><span>${text}</span>`;
        div.draggable = true;
        div.ondragstart = () => { draggedItem = div; };
        div.ondragover = e => e.preventDefault();
        div.ondrop = e => {
          e.preventDefault();
          if (draggedItem && draggedItem !== div) {
            const allItems = [...list.children];
            const fromIdx = allItems.indexOf(draggedItem);
            const toIdx = allItems.indexOf(div);
            const newItems = [...items];
            const [moved] = newItems.splice(fromIdx, 1);
            newItems.splice(toIdx, 0, moved);
            roomRef.child('itinerary').set(newItems);
          }
        };
        list.appendChild(div);
      });
    });

    // 同步路線 & 地圖連結
    roomRef.child('route').on('value', snap => {
      const route = snap.val() || '';
      const input = document.getElementById(mode === 'plan' ? 'routeInput' : 'shareCode');
      if (input) input.value = route;
      const mapLink = document.getElementById('mapLink') || document.createElement('a');
      mapLink.href = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(route.split(' → ')[0])}&destination=${encodeURIComponent(route.split(' → ').pop())}&travelmode=driving`;
      mapLink.textContent = '開啟 Google Maps 自駕導航';
      mapLink.style.display = route ? 'block' : 'none';
      document.getElementById(mapId).appendChild(mapLink);
    });

    // 同步留言
    roomRef.child('comments').on('value', snap => {
      const comments = snap.val() || [];
      const commentList = document.getElementById(commentId);
      commentList.innerHTML = '';
      comments.forEach(c => {
        const div = document.createElement('div');
        div.className = 'comment-item';
        div.innerHTML = `<strong>${c.user}:</strong> ${c.text} <small>(${new Date(c.time).toLocaleString()})</small>`;
        commentList.appendChild(div);
      });
    });

    // 上線同步
    roomRef.child('online').on('value', snap => {
      const users = snap.val() || {};
      document.getElementById(onlineId).textContent = Object.keys(users).length;
    });

    // 自動離線
    const myOnlineRef = roomRef.child('online').push();
    myOnlineRef.set({ user: myName, time: Date.now() });
    myOnlineRef.onDisconnect().remove();

    // 儲存函數
    window.saveSync = () => {
      if (!currentRoomId) return;
      const route = document.getElementById('routeInput') ? document.getElementById('routeInput').value : '';
      roomRef.child('route').set(route);
    };

    window.saveComment = () => {
      if (!currentRoomId) return;
      const text = document.getElementById('commentInput').value.trim();
      if (text) {
        roomRef.child('comments').push({ user: myName, text, time: Date.now() });
        document.getElementById('commentInput').value = '';
      }
    };
  }

  // AI 生成自駕路線
  function aiGenerate() {
    const routes = ['東京 → 箱根溫泉 → 富士山 → 京都', '大阪 → 奈良 → 京都 → 箱根 → 東京', '名古屋 → 伊勢神宮 → 京都 → 大阪'];
    const randomRoute = routes[Math.floor(Math.random() * routes.length)];
    document.getElementById('routeInput').value = randomRoute;
    saveSync();
    // 模擬 Firebase 更新行程
    const spots = randomRoute.split(' → ').map(s => s + ' 探索');
    db.ref('rooms/' + currentRoomId + '/itinerary').set(spots);
  }

  // 加預算計算（留言靈感）
  function addBudget() {
    const budgetInput = prompt('輸入預算總額 (NTD)');
    if (budgetInput) {
      const comments = document.getElementById('commentsList');
      const div = document.createElement('div');
      div.className = 'comment-item';
      div.innerHTML = `<strong>系統:</strong> 預算設定 ${budgetInput} 元（油費/住宿/餐飲自動分攤）`;
      comments.appendChild(div);
      saveComment(); // 觸發同步
    }
  }

  let draggedItem = null;

  window.onload = () => showPage('home');
</script>
</body>
</html>
