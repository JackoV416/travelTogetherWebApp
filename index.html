<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸€èµ·æ—…è¡Œ</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#8B7E6A">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#FAF9F6;--card:#FFF;--accent:#8B7E6A;--text:#333;--soft:#B8A89A;--border:#e0e0e0}
    body.dark{--bg:#000;--card:#1a1a1a;--accent:#D4C2A9;--text:#f0f0f0;--soft:#B89A7A;--border:#333}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:'Noto Serif TC',serif;font-size:16px;line-height:1.8;transition:all .3s}
    header{background:var(--accent);color:white;padding:18px 15px;text-align:center;position:fixed;width:100%;top:0;z-index:1000;box-shadow:0 4px 20px rgba(0,0,0,0.1)}
    header h1{font-family:'ZCOOL XiaoWei',serif;font-size:28px;letter-spacing:2px}
    .moon{position:absolute;top:20px;right:20px;font-size:22px;cursor:pointer;opacity:0.9}
    main{padding-top:100px;padding-bottom:40px;max-width:900px;margin:0 auto;padding-left:15px;padding-right:15px}
    .card{background:var(--card);padding:32px;margin:20px 0;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.1)}
    h2{color:var(--accent);font-size:26px;text-align:center;margin-bottom:25px}
    input,select,textarea{width:100%;padding:16px;margin:12px 0;border:none;border-radius:16px;font-size:17px;background:#f0f0f0;color:var(--text)}
    input[type="date"]{background:#f0f0f0;-webkit-appearance:none}
    button{background:var(--accent);color:white;padding:18px;border:none;border-radius:20px;font-size:18px;cursor:pointer;font-weight:600;margin:20px auto;display:block;width:90%;pointer-events:auto}
    button:hover{background:var(--soft);transform:scale(1.02);transition:0.3s}
    .nav-btn{background:var(--accent);color:white;padding:10px 20px;border-radius:12px;font-size:14px;text-decoration:none;display:inline-block;margin-top:10px;pointer-events:auto}
    .nav-btn:hover{background:var(--soft);transform:scale(1.02)}
    .day-card{background:#f9f9f9;border-radius:16px;padding:22px;margin:20px 0}
    body.dark .day-card{background:#2a2a2a}
    .cat{padding:16px;background:var(--card);border-left:5px solid var(--accent);border-radius:10px;margin:10px 0;position:relative;min-height:80px}
    .highlight{padding:5px 12px;border-radius:8px;color:white;font-weight:bold;margin:3px;font-size:14px;display:inline-block}
    .must-eat{background:#4caf50}.must-buy{background:#ff9800}.res{background:#f44336}
    .weather{background:var(--soft);color:white;padding:10px;border-radius:10px;text-align:center;margin-bottom:15px}
    #totalHKD{font-size:32px;font-weight:bold;text-align:center;margin:30px 0;color:#4caf50}
    .tip{margin:20px 0;padding:18px;background:#f0f0f0;border-radius:14px;font-size:15px}
    body.dark .tip{background:#333}
    .room-code{font-size:36px;font-weight:bold;color:var(--accent);letter-spacing:8px;margin:25px 0;text-align:center}
    .online{text-align:center;margin:15px 0;color:var(--soft);font-size:15px}
    .currency-row{display:grid;grid-template-columns:3fr 1fr;gap:10px;align-items:center;margin:10px 0}
    .profile-card{margin:20px 0;padding:20px;background:var(--soft);border-radius:14px;text-align:center}
    .profile-btn{background:var(--accent);color:white;padding:10px 20px;border-radius:12px;font-size:16px;cursor:pointer;margin:10px;display:inline-block}
    .trip-list{margin:30px 0}
    .trip-item{padding:18px;background:var(--card);border-radius:14px;margin:15px 0;box-shadow:0 6px 20px rgba(0,0,0,0.08);cursor:pointer}
    .trip-item.active{background:var(--soft);color:white}
    .search-bar{margin-bottom:20px}
    .transfer-input{margin-top:10px;padding:12px;background:#f0f0f0;border-radius:12px}
    body.dark .transfer-input{background:#333}
    @media (min-width:768px){
      main{padding:100px 30px}
      button{width:80%;max-width:400px}
      .card{max-width:700px;margin:30px auto}
      .nav-btn{padding:12px 24px;font-size:15px}
    }
  </style>
</head>
<body>

<header>
  <h1>ä¸€èµ·æ—…è¡Œ</h1>
  <div class="moon" onclick="document.body.classList.toggle('dark')">ğŸŒ™</div>
</header>

<main>
  <div class="card">
    <!-- æ­¡è¿æ•™å­¸ -->
    <h2>æ­¡è¿ä¾†åˆ°ä¸€èµ·æ—…è¡Œ</h2>
    <p style="text-align:center;font-size:18px;margin-bottom:30px">ä½ çš„æ—¥æœ¬è‡ªé§•å…±ç·¨ç¥å™¨ï¼Œæ”¯æ´å¤šäººå³æ™‚ç·¨è¼¯</p>
    
    <div class="tip">
      <strong>åŠŸèƒ½äº®é»ï¼š</strong><br>
      â€¢ æ¯æ—¥è¡Œç¨‹è‡ªå‹•åˆ†é¡ + ä¸€éµå°èˆª<br>
      â€¢ å¿…åƒå¿…è²·æ”»ç•¥è‡ªå‹•æ¨™è‰²<br>
      â€¢ æ¸¯å¹£ãƒ»æ—¥åœ“ãƒ»å°å¹£è¨˜å¸³ï¼Œç¸½çµè‡ªå‹•æ›ç®—æ¸¯å¹£<br>
      â€¢ èˆªç­ã€ä½å®¿ã€é¦™æ¸¯ç·Šæ€¥é›»è©±<br>
      â€¢ 6 ç¢¼åˆ†äº«ï¼Œå®¶äººå³æ™‚ä¸€èµ·ç·¨
    </div>

    <!-- ç™»å…¥å€‹äººæª”æ¡ˆ -->
    <div class="profile-card">
      <h3>å€‹äººæª”æ¡ˆ</h3>
      <input type="text" id="username" placeholder="è¼¸å…¥ç”¨æˆ¶åç™»å…¥" value="guest" oninput="login()">
      <p id="userStatus" style="margin:15px 0">ç›®å‰èº«ä»½ï¼šè¨ªå®¢</p>
      <h3>æˆ‘çš„è¡Œç¨‹</h3>
      <div id="myTrips" class="trip-list"></div>
      <h3>å…±åŒç·¨è¼¯è¡Œç¨‹</h3>
      <div id="sharedTrips" class="trip-list"></div>
      <div class="search-bar">
        <input type="text" id="searchCode" placeholder="æœå°‹æœ‹å‹è¡Œç¨‹ä»£ç¢¼" maxlength="6" style="letter-spacing:6px;font-size:22px">
        <button onclick="searchRoom()" class="profile-btn">æœå°‹ä¸¦åŠ å…¥</button>
      </div>
    </div>
    
    <!-- å»ºç«‹è¡Œç¨‹ -->
    <h2>å»ºç«‹æ–°è¡Œç¨‹</h2>
    <div class="dropdown">
      <label>æ—…è¡Œåœ‹å®¶ï¼ˆå¯å¤šé¸ï¼‰</label>
      <select id="countries" multiple oninput="updateCities()">
        <option value="æ—¥æœ¬">æ—¥æœ¬</option>
        <option value="éŸ“åœ‹">éŸ“åœ‹</option>
        <option value="æ³°åœ‹">æ³°åœ‹</option>
        <option value="å°ç£">å°ç£</option>
        <option value="æ–°åŠ å¡">æ–°åŠ å¡</option>
        <option value="è¶Šå—">è¶Šå—</option>
        <option value="é¦¬ä¾†è¥¿äº">é¦¬ä¾†è¥¿äº</option>
        <option value="æ¾³æ´²">æ¾³æ´²</option>
        <option value="ä¸­åœ‹">ä¸­åœ‹</option>
        <option value="ç¾åœ‹">ç¾åœ‹</option>
        <!-- åŠ æ›´å¤šåœ‹å®¶... -->
      </select>
    </div>

    <div class="dropdown">
      <label>ä¸»è¦åŸå¸‚ï¼ˆå¯å¤šé¸ï¼‰</label>
      <select id="cities" multiple>
        <!-- å‹•æ…‹æ›´æ–° -->
      </select>
    </div>

    <input type="number" id="people" placeholder="æ—…ç¨‹äººæ•¸" value="4" oninput="save()">
    <input type="date" id="startDate" oninput="calcDates()">
    <input type="date" id="endDate" oninput="calcDates()">
    <span id="dateRange" style="display:block;text-align:center;margin:10px 0"></span>

    <h3>èˆªç­è³‡è¨Š</h3>
    <input type="text" id="flight" placeholder="å»ç¨‹èˆªç­ç·¨è™Ÿï¼ˆå¦‚ CX520ï¼‰" onblur="fetchFlight(this.value)">
    <p id="flightInfo" style="font-size:14px;margin:10px 0"></p>
    <div class="price-row">
      <input type="number" id="flightPrice" placeholder="æ©Ÿç¥¨åƒ¹æ ¼" oninput="save()">
      <select id="flightCurrency" oninput="save()"><option>HKD</option><option>JPY</option><option>TWD</option><option>USD</option><option>RMB</option></select>
    </div>

    <div class="transfer-input">
      <input type="text" id="transferFlight" placeholder="è½‰æ©Ÿèˆªç­ï¼ˆé¸å¡«ï¼‰" onblur="fetchFlight(this.value)">
      <p id="transferInfo" style="font-size:14px;margin:10px 0"></p>
      <input type="text" id="transferTime" placeholder="ç­‰å€™æ™‚é–“ï¼ˆä¾‹ï¼š2å°æ™‚ï¼‰" oninput="save()">
    </div>

    <input type="text" id="flightBack" placeholder="å›ç¨‹èˆªç­ç·¨è™Ÿï¼ˆé¸å¡«ï¼‰" onblur="fetchFlight(this.value)">
    <p id="flightBackInfo" style="font-size:14px;margin:10px 0"></p>
    <div class="price-row">
      <input type="number" id="flightBackPrice" placeholder="å›ç¨‹åƒ¹æ ¼" oninput="save()">
      <select id="flightBackCurrency" oninput="save()"><option>HKD</option><option>JPY</option><option>TWD</option><option>USD</option><option>RMB</option></select>
    </div>

    <input type="text" id="friendFlight" placeholder="æœ‹å‹èˆªç­ï¼ˆé¸å¡«ï¼‰" onblur="fetchFlight(this.value)">
    <p id="friendFlightInfo" style="font-size:14px;margin:10px 0"></p>

    <h3>ä½å®¿è³‡è¨Š</h3>
    <select id="accommodationType" oninput="save()">
      <option>é…’åº—</option>
      <option>æ°‘å®¿</option>
      <option>å…¶ä»–</option>
    </select>
    <input type="text" id="hotelName" placeholder="ä½å®¿åç¨±" oninput="save()">
    <div class="price-row">
      <input type="number" id="hotelPrice" placeholder="åƒ¹æ ¼" oninput="save()">
      <select id="hotelCurrency" oninput="save()"><option>HKD</option><option>JPY</option><option>TWD</option><option>USD</option><option>RMB</option></select>
    </div>
    <input type="number" id="nights" placeholder="å…¥ä½æ™šæ•¸" oninput="save()">
    <input type="text" id="roomType" placeholder="æˆ¿å‹ï¼ˆå¦‚ é›™äººæˆ¿ï¼‰" oninput="save()">

    <h3>äº¤é€šæ–¹å¼</h3>
    <select id="transportType" oninput="save()">
      <option>ç§Ÿè»Š</option>
      <option>JR Pass</option>
      <option>åœ°éµï¼é›»è»Šï¼é«˜éµ</option>
      <option>åŒ…è»Š</option>
      <option>å…¶ä»–</option>
    </select>
    <textarea id="transportInfo" rows="3" placeholder="äº¤é€šè©³æƒ…ï¼ˆå¦‚ç§Ÿè»Šå…¬å¸æˆ–æ¯å¤©ä¸åŒæ–¹å¼ï¼‰" oninput="save()"></textarea>
    <div class="price-row">
      <input type="number" id="transportPrice" placeholder="äº¤é€šè²»ç”¨" oninput="save()">
      <select id="transportCurrency" oninput="save()"><option>HKD</option><option>JPY</option><option>TWD</option><option>USD</option><option>RMB</option></select>
    </div>

    <button onclick="finishCreate()" style="background:#4caf50">å®Œæˆå»ºç«‹</button>
  </div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = { databaseURL: "https://travel-together-2025-default-rtdb.asia-southeast1.firebasedatabase.app" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  let roomRef = null;
  let currentRoom = null;

  function calcDates() {
    // åŒä¹‹å‰
  }

  function finishCreate() {
    currentRoom = Math.random().toString(36).substring(2,8).toUpperCase();
    roomRef = db.ref('trips/' + currentRoom);
    
    const info = {
      countries: Array.from(document.getElementById('countries').selectedOptions).map(o => o.value),
      cities: Array.from(document.getElementById('cities').selectedOptions).map(o => o.value),
      people: document.getElementById('people').value,
      startDate: document.getElementById('startDate').value,
      endDate: document.getElementById('endDate').value,
      flight: document.getElementById('flight').value,
      flightPrice: document.getElementById('flightPrice').value,
      flightCurrency: document.getElementById('flightCurrency').value,
      transferFlight: document.getElementById('transferFlight').placeholder,
      transferTime: document.getElementById('transferTime').value,
      flightBack: document.getElementById('flightBack').value,
      flightBackPrice: document.getElementById('flightBackPrice').value,
      flightBackCurrency: document.getElementById('flightBackCurrency').value,
      friendFlight: document.getElementById('friendFlight').value,
      accommodationType: document.getElementById('accommodationType').value,
      hotelName: document.getElementById('hotelName').value,
      hotelPrice: document.getElementById('hotelPrice').value,
      hotelCurrency: document.getElementById('hotelCurrency').value,
      nights: document.getElementById('nights').value,
      roomType: document.getElementById('roomType').value,
      transportType: document.getElementById('transportType').value,
      transportInfo: document.getElementById('transportInfo').value,
      transportPrice: document.getElementById('transportPrice').value,
      transportCurrency: document.getElementById('transportCurrency').value
    };

    roomRef.set({
      info: info,
      itinerary: generateSampleItinerary(info),
      budget: {hkd:0,jpy:0,twd:0}
    }).then(()=>{
      document.getElementById('tripTitle').textContent = info.countries.join('ãƒ»') + ' è‡ªé§•æ—…è¡Œ';
      document.getElementById('tripInfo').textContent = `${info.people}äºº â€¢ ${info.startDate} - ${info.endDate}`;
      showTab(1);
      loadItinerary();
      setupOnline();
    });
  }

  function generateSampleItinerary(info) {
    // æ ¹æ“šè¼¸å…¥ç”Ÿæˆç¯„ä¾‹è¡Œç¨‹
    const days = 5; // ç¯„ä¾‹5å¤©
    const itinerary = [];
    for(let d=1; d<=days; d++){
      itinerary.push({day:d,loc:info.cities[d-1] || 'åŸå¸‚'+d,cat:"æ™¯é»",title:"è‘—åæ™¯é»",story:"æ¢ç´¢åŸå¸‚ç²¾è¯",mustEat:"ç•¶åœ°ç¾é£Ÿ",mustBuy:"ç´€å¿µå“",res:""});
      itinerary.push({day:d,loc:info.cities[d-1] || 'åŸå¸‚'+d,cat:"é¤å»³",title:"æ¨è–¦é¤å»³",story:"å“å˜—åœ°é“æ–™ç†",mustEat:"å¿…é»èœå–®",res:"éœ€é ç´„"});
      itinerary.push({day:d,loc:info.cities[d-1] || 'åŸå¸‚'+d,cat:"äº¤é€š",title:"ç•¶æ—¥äº¤é€š",story:"äº¤é€šè©³æƒ…",res:""});
    }
    return itinerary;
  }

  // å…¶ä»–å‡½å¼å¦‚ loadItinerary, calc, setupOnline, fetchFlight åŒä¹‹å‰

  window.onload = () => {
    document.getElementById('tripView').style.display = 'none';
    loadTrips();
  };
</script>
</body>
</html>