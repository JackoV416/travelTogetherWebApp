<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸€èµ·æ—…è¡Œ</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#8B7E6A">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#FAF9F6;--card:#FFF;--accent:#8B7E6A;--text:#333;--soft:#B8A89A;--border:#e0e0e0}
    body.dark{--bg:#000000;--card:#1a1a1a;--accent:#D4C2A9;--text:#f0f0f0;--soft:#B89A7A;--border:#333}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:'Noto Serif TC',serif;font-size:16px;line-height:1.8;transition:all .3s}
    header{background:var(--accent);color:white;padding:18px 15px;text-align:center;position:fixed;width:100%;top:0;z-index:1000;box-shadow:0 4px 20px rgba(0,0,0,0.1)}
    header h1{font-family:'ZCOOL XiaoWei',serif;font-size:28px;letter-spacing:2px}
    .moon{position:absolute;top:20px;right:20px;font-size:22px;cursor:pointer;opacity:0.9}
    main{padding-top:100px;padding-bottom:40px;max-width:900px;margin:0 auto;padding-left:15px;padding-right:15px}
    .card{background:var(--card);padding:32px;margin:20px 0;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.08)}
    h2{color:var(--accent);font-size:26px;text-align:center;margin-bottom:25px}
    input,select,textarea{width:100%;padding:16px;margin:12px 0;border:none;border-radius:16px;font-size:17px;background:#f0f0f0;color:var(--text)}
    input[type="date"]{background:#f0f0f0;-webkit-appearance:none}
    button{background:var(--accent);color:white;padding:18px;border:none;border-radius:20px;font-size:18px;cursor:pointer;font-weight:600;margin:20px auto;display:block;width:90%}
    .nav-btn{background:var(--accent);color:white;padding:10px 20px;border-radius:12px;font-size:14px;text-decoration:none;display:inline-block;margin-top:10px}
    .day-card{background:#f9f9f9;border-radius:16px;padding:22px;margin:20px 0}
    body.dark .day-card{background:#2a2a2a}
    .cat{padding:16px;background:var(--card);border-left:5px solid var(--accent);border-radius:10px;margin:10px 0;position:relative;min-height:80px}
    .highlight{padding:5px 12px;border-radius:8px;color:white;font-weight:bold;margin:3px;font-size:14px;display:inline-block}
    .must-eat{background:#4caf50}.must-buy{background:#ff9800}.res{background:#f44336}
    .weather{background:var(--soft);color:white;padding:10px;border-radius:10px;text-align:center;margin-bottom:15px}
    #totalHKD{font-size:32px;font-weight:bold;text-align:center;margin:30px 0;color:#4caf50}
    .tip{margin:20px 0;padding:18px;background:#f0f0f0;border-radius:14px;font-size:15px}
    body.dark .tip{background:#333}
    .room-code{font-size:36px;font-weight:bold;color:var(--accent);letter-spacing:8px;margin:25px 0;text-align:center}
    .online{text-align:center;margin:15px 0;color:var(--soft);font-size:15px}
    .profile-card{margin:20px 0;padding:20px;background:var(--soft);border-radius:14px;text-align:center}
    .profile-btn{background:var(--accent);color:white;padding:10px 20px;border-radius:12px;font-size:16px;cursor:pointer;margin:10px;display:inline-block}
    .trip-list{margin:30px 0}
    .trip-item{padding:18px;background:var(--card);border-radius:14px;margin:15px 0;box-shadow:0 6px 20px rgba(0,0,0,0.08);cursor:pointer}
    .trip-item.active{background:var(--soft);color:white}
    .currency-row{display:grid;grid-template-columns:3fr 1fr;gap:10px;align-items:center;margin:15px 0}
    .transfer-input{margin-top:10px;padding:12px;background:#f0f0f0;border-radius:12px}
    body.dark .transfer-input{background:#333}
  </style>
</head>
<body>

<header>
  <h1>ä¸€èµ·æ—…è¡Œ</h1>
  <div class="moon" onclick="document.body.classList.toggle('dark')">ğŸŒ™</div>
</header>

<main>
  <div class="card">
    <!-- æ­¡è¿æ•™å­¸ -->
    <h2>æ­¡è¿ä¾†åˆ°ä¸€èµ·æ—…è¡Œ</h2>
    <p style="text-align:center;font-size:18px;margin-bottom:30px">ä½ çš„æ—¥æœ¬è‡ªé§•å…±ç·¨ç¥å™¨ï¼Œæ”¯æ´å¤šäººå³æ™‚ç·¨è¼¯</p>
    
    <div class="tip">
      <strong>åŠŸèƒ½äº®é»ï¼š</strong><br>
      â€¢ æ¯æ—¥è¡Œç¨‹è‡ªå‹•åˆ†é¡ + ä¸€éµå°èˆª<br>
      â€¢ å¿…åƒå¿…è²·æ”»ç•¥è‡ªå‹•æ¨™è‰²<br>
      â€¢ æ¸¯å¹£ãƒ»æ—¥åœ“ãƒ»å°å¹£è¨˜å¸³ï¼Œç¸½çµè‡ªå‹•æ›ç®—æ¸¯å¹£<br>
      â€¢ èˆªç­ã€ä½å®¿ã€é¦™æ¸¯ç·Šæ€¥é›»è©±<br>
      â€¢ 6 ç¢¼åˆ†äº«ï¼Œå®¶äººå³æ™‚ä¸€èµ·ç·¨
    </div>

    <!-- ç™»å…¥å€‹äººæª”æ¡ˆ -->
    <div class="profile-card">
      <h3>å€‹äººæª”æ¡ˆ</h3>
      <input type="text" id="username" placeholder="è¼¸å…¥ç”¨æˆ¶åç™»å…¥" value="guest">
      <button onclick="login()" class="profile-btn">ç™»å…¥</button>
      <p id="userStatus" style="margin:15px 0">ç›®å‰èº«ä»½ï¼šè¨ªå®¢</p>
      <h3>æˆ‘çš„è¡Œç¨‹</h3>
      <div id="myTrips" class="trip-list"></div>
      <h3>å…±åŒç·¨è¼¯è¡Œç¨‹</h3>
      <div id="sharedTrips" class="trip-list"></div>
      <div class="search-bar">
        <input type="text" id="searchCode" placeholder="æœå°‹æœ‹å‹è¡Œç¨‹ä»£ç¢¼" maxlength="6" style="letter-spacing:6px;font-size:22px">
        <button onclick="searchRoom()" class="profile-btn">æœå°‹ä¸¦åŠ å…¥</button>
      </div>
    </div>
    
    <!-- å»ºç«‹è¡Œç¨‹ -->
    <h2>å»ºç«‹æ–°è¡Œç¨‹</h2>
    <input type="text" id="countries" placeholder="æ—…è¡Œåœ‹å®¶ï¼ˆå¯å¤šå€‹ï¼‰" value="æ—¥æœ¬">
    <input type="text" id="cities" placeholder="ä¸»è¦åŸå¸‚ï¼ˆå¯å¤šå€‹ï¼‰" value="æ±äº¬,ç®±æ ¹,å¯Œå£«å±±,äº¬éƒ½,å¤§é˜ª">
    <input type="number" id="people" placeholder="æ—…ç¨‹äººæ•¸" value="4">
    <input type="date" id="startDate" placeholder="é–‹å§‹æ—¥æœŸ" oninput="calcDates()">
    <input type="date" id="endDate" placeholder="çµæŸæ—¥æœŸ" oninput="calcDates()">
    <span id="dateRange" style="display:block;text-align:center;margin:10px 0"></span>
    
    <h3>èˆªç­è³‡è¨Š</h3>
    <input type="text" id="flight" placeholder="å»ç¨‹èˆªç­ç·¨è™Ÿï¼ˆå¦‚ CX520ï¼‰" onblur="fetchFlight(this.value)">
    <p id="flightInfo" style="font-size:14px;margin:10px 0"></p>
    <div class="transfer-input">
      <input type="text" id="transferFlight" placeholder="è½‰æ©Ÿèˆªç­ï¼ˆé¸å¡«ï¼‰" onblur="fetchFlight(this.value)">
      <input type="text" id="transferTime" placeholder="ç­‰å€™æ™‚é–“ï¼ˆä¾‹ï¼š2å°æ™‚ï¼‰" oninput="save()">
      <p id="transferInfo" style="font-size:14px;margin:10px 0"></p>
    </div>
    <input type="text" id="flightBack" placeholder="å›ç¨‹èˆªç­ç·¨è™Ÿï¼ˆé¸å¡«ï¼‰" onblur="fetchFlight(this.value)">
    <p id="flightBackInfo" style="font-size:14px;margin:10px 0"></p>
    <input type="text" id="friendFlight" placeholder="æœ‹å‹èˆªç­ï¼ˆé¸å¡«ï¼‰" onblur="fetchFlight(this.value)">
    <p id="friendFlightInfo" style="font-size:14px;margin:10px 0"></p>
    
    <h3>ä½å®¿è³‡è¨Š</h3>
    <textarea id="hotel" rows="4" placeholder="é…’åº—åç¨±ã€åœ°å€ã€å…¥ä½æ—¥æœŸã€åƒ¹æ ¼ï¼ˆå¯å¤šå€‹ï¼‰" oninput="save()"></textarea>
    
    <h3>äº¤é€šæ–¹å¼</h3>
    <textarea id="transport" rows="3" placeholder="æ¯å¤©äº¤é€šæ–¹å¼ï¼ˆå¯ä¸åŒï¼Œå¦‚Day1:ç§Ÿè»Š, Day2:JR Passï¼‰" oninput="save()"></textarea>
    
    <button onclick="finishCreate()" class="green">å®Œæˆè£½ä½œ</button>
  </div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = { databaseURL: "https://travel-together-2025-default-rtdb.asia-southeast1.firebasedatabase.app" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let user = localStorage.getItem('user') || 'guest';
  let myTrips = JSON.parse(localStorage.getItem('myTrips')) || [];
  let sharedTrips = JSON.parse(localStorage.getItem('sharedTrips')) || [];

  document.getElementById('userStatus').textContent = `ç›®å‰èº«ä»½ï¼š${user}`;
  document.getElementById('username').value = user;

  function login(){
    user = document.getElementById('username').value.trim() || 'guest';
    localStorage.setItem('user', user);
    document.getElementById('userStatus').textContent = `ç›®å‰èº«ä»½ï¼š${user}`;
    loadTrips();
  }

  function loadTrips(){
    let html = '';
    myTrips.forEach(t=>{
      html += `<div class="trip-item" onclick="loadTrip('${t.code}')"><strong>${t.name}</strong><br><small>è‡ªå»ºè¡Œç¨‹</small></div>`;
    });
    document.getElementById('myTrips').innerHTML = html;

    html = '';
    sharedTrips.forEach(t=>{
      html += `<div class="trip-item" onclick="loadTrip('${t.code}')"><strong>${t.name}</strong><br><small>å…±åŒç·¨è¼¯</small></div>`;
    });
    document.getElementById('sharedTrips').innerHTML = html;
  }

  function searchRoom(){
    const code = document.getElementById('searchCode').value.toUpperCase();
    if(code.length !==6) return alert("è«‹è¼¸å…¥6ç¢¼");
    loadTrip(code);
    sharedTrips.push({code, name: 'æœ‹å‹è¡Œç¨‹'});
    localStorage.setItem('sharedTrips', JSON.stringify(sharedTrips));
    loadTrips();
  }

  function loadTrip(code){
    currentRoom = code;
    roomRef = db.ref('trips/'+currentRoom);
    document.getElementById('roomCode').textContent = currentRoom;
    loadItinerary();
    setupOnline();
  }

  function calcDates() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    if(start && end) {
      const s = new Date(start);
      const e = new Date(end);
      const days = Math.ceil((e - s) / (1000 * 60 * 60 * 24)) + 1;
      document.getElementById('dateRange').textContent = `æ—…ç¨‹å…± ${days} å¤©`;
    }
  }

  function finishCreate() {
    currentRoom = Math.random().toString(36).substring(2,8).toUpperCase();
    roomRef = db.ref('trips/'+currentRoom);
    document.getElementById('roomCode').textContent = currentRoom;
    const basicInfo = {
      countries: document.getElementById('countries').value,
      cities: document.getElementById('cities').value,
      people: document.getElementById('people').value,
      startDate: document.getElementById('startDate').value,
      endDate: document.getElementById('endDate').value,
      flight: document.getElementById('flight').value,
      flightBack: document.getElementById('flightBack').value,
      friendFlight: document.getElementById('friendFlight').value,
      transferFlight: document.getElementById('transferFlight').value,
      transferTime: document.getElementById('transferTime').value,
      hotel: document.getElementById('hotel').value,
      transport: document.getElementById('transport').value
    };
    roomRef.set({
      info: basicInfo,
      itinerary: generateSampleItinerary(),
      budget: {hkd:0,jpy:0,twd:0}
    }).then(()=>{
      myTrips.push({code: currentRoom, name: basicInfo.countries + ' æ—…è¡Œ'});
      localStorage.setItem('myTrips', JSON.stringify(myTrips));
      loadTrips();
      loadItinerary();
      setupOnline();
    });
  }

  function fetchFlight(code) {
    // æ¨¡æ“¬å³æ™‚æŸ¥è©¢
    if (code) {
      const p = document.getElementById(code.toLowerCase() + 'Info');
      if(p) p.textContent = 'å³æ™‚è³‡è¨Šï¼šæ™‚é–“ 09:00 | æ©Ÿå ´ HKIA | ç™»æ©Ÿå£ B10 | æœ€æ–°ç‹€æ…‹ï¼šæº–æ™‚';
    }
  }

  // å…¶ä»–å‡½å¼å¦‚ loadItinerary, calc, setupOnline, generateSampleItinerary åŒå‰ï¼ˆçœç•¥ï¼‰

  loadTrips();
</script>
</body>
</html>
