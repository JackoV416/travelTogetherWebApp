<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>一起旅行・文青版</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#F4F1E9">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#F4F1E9; --card:#FFFDF9; --accent:#6B9080; --text:#4A4A4A; --light:#A4C3B2; }
    @media (prefers-color-scheme: dark) { :root { --bg:#1E1E1E; --card:#2A2A2A; --accent:#A4C3B2; --text:#E8E8E8; --light:#6B9080; } }
    body.dark { --bg:#1E1E1E; --card:#2A2A2A; --accent:#A4C3B2; --text:#E8E8E8; --light:#6B9080; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--bg); color:var(--text); font-family:'Noto Serif TC',serif; line-height:1.8; }
    header { background:var(--accent); color:white; padding:20px; text-align:center; position:fixed; width:100%; top:0; z-index:1000; }
    header h1 { font-family:'ZCOOL XiaoWei',serif; font-size:26px; }
    nav { display:flex; justify-content:center; gap:20px; margin-top:10px; flex-wrap:wrap; }
    nav a { color:white; text-decoration:none; font-size:14px; opacity:0.9; }
    nav a.active { opacity:1; border-bottom:2px solid white; padding-bottom:5px; }
    main { margin-top:90px; padding:20px; max-width:900px; margin-left:auto; margin-right:auto; }
    .page { display:none; animation:fadeIn 0.6s; }
    .page.active { display:block; }
    .card { background:var(--card); padding:25px; margin:20px 0; border-radius:16px; box-shadow:0 8px 30px rgba(0,0,0,0.08); }
    h2 { font-family:'ZCOOL XiaoWei',serif; color:var(--accent); margin-bottom:20px; text-align:center; }
    input, button { width:100%; padding:14px; margin:10px 0; border:none; border-radius:12px; font-size:16px; }
    input { background:#f8f8f8; }
    body.dark input { background:#333; color:white; }
    button { background:var(--accent); color:white; font-weight:bold; cursor:pointer; }
    .btn-small { padding:10px 20px; width:auto; display:inline-block; margin:5px; }

    /* 拖曳行程 */
    #itineraryList { margin-top:20px; }
    .itinerary-item { background:white; padding:15px; margin:10px 0; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1); cursor:move; display:flex; align-items:center; }
    body.dark .itinerary-item { background:#333; }
    .itinerary-item.dragging { opacity:0.5; }
    .itinerary-item span { flex:1; font-size:16px; }
    .itinerary-item .drag-handle { cursor:grab; font-size:20px; margin-right:10px; color:#999; }

    /* 地圖 */
    #locationMap { height:400px; margin-top:20px; border-radius:12px; overflow:hidden; box-shadow:0 4px 20px rgba(0,0,0,0.1); }

    @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
    @media (max-width:768px) { main { padding:15px; margin-top:100px; } #locationMap { height:300px; } }
  </style>
</head>
<body>
  <header>
    <h1>一起旅行</h1>
    <nav>
      <a href="#" class="active" onclick="show('home')">首頁</a>
      <a href="#" onclick="show('plan')">行程</a>
      <a href="#" onclick="show('budget')">預算</a>
      <a href="#" onclick="show('nav')">導航</a>
      <a href="#" onclick="show('room')">共編</a>
    </nav>
  </header>

  <main>
    <!-- 首頁略 -->

    <!-- 行程規劃頁（重磅升級） -->
    <section id="plan" class="page">
      <div class="card">
        <h2>行程規劃・天氣與地圖</h2>
        <input type="text" id="destination" placeholder="目的地（例如：京都）" oninput="updateMap()">
        <input type="number" id="days" placeholder="幾天幾夜">
        <button onclick="generateItinerary()">生成行程</button>
        <button class="btn-small" onclick="getAIAttractions()">AI 給我靈感</button>

        <!-- 拖曳行程清單 -->
        <div id="itineraryList"></div>

        <!-- 內嵌地圖 -->
        <div id="locationMap">
          <iframe width="100%" height="100%" frameborder="0" style="border:0" src="" allowfullscreen></iframe>
        </div>
      </div>
    </section>

    <!-- 其他頁面（預算、導航、共編）保持不變 -->
  </main>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = { databaseURL: "https://travel-together-2025-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentRoom = null;
    let currentVersion = "default";
    let itineraryOrder = [];

    // 更新地圖
    function updateMap() {
      const dest = document.getElementById('destination').value.trim();
      if (!dest) return;
      const url = `https://www.google.com/maps/embed/v1/place?key=AIzaSyD-9tSrke72PouQMnMX-a7eZSW0jkFMBWY&q=${encodeURIComponent(dest)}`;
      document.querySelector('#locationMap iframe').src = url;
    }

    // 生成行程（含拖曳）
    function generateItinerary() {
      const dest = document.getElementById('destination').value || "未知地點";
      const days = parseInt(document.getElementById('days').value) || 3;
      const list = document.getElementById('itineraryList');
      list.innerHTML = "";
      itineraryOrder = [];

      for(let i=1; i<=days; i++) {
        const item = document.createElement('div');
        item.className = "itinerary-item";
        item.draggable = true;
        item.innerHTML = `<span class="drag-handle">⋮⋮</span><span>第 ${i} 天・${dest} 自由探索</span>`;
        item.ondragstart = dragStart;
        item.ondragover = dragOver;
        item.ondrop = drop;
        list.appendChild(item);
        itineraryOrder.push(item);
      }
      updateMap();
      saveData();
    }

    // AI推薦景點（直接加到行程）
    async function getAIAttractions() {
      const city = document.getElementById('destination').value || "台北";
      const list = document.getElementById('itineraryList');
      const attractions = ["京都御所", "清水寺", "伏見稻荷大社", "金閣寺", "嵐山竹林", "哲學之道", "鴨川散步"];
      
      attractions.slice(0, 5).forEach(attr => {
        const item = document.createElement('div');
        item.className = "itinerary-item";
        item.draggable = true;
        item.innerHTML = `<span class="drag-handle">⋮⋮</span><span>${attr}</span>`;
        item.ondragstart = dragStart;
        item.ondragover = dragOver;
        item.ondrop = drop;
        list.appendChild(item);
        itineraryOrder.push(item);
      });
      saveData();
    }

    // 拖曳功能
    let draggedItem = null;
    function dragStart(e) { draggedItem = this; this.classList.add('dragging'); }
    function dragOver(e) { e.preventDefault(); }
    function drop(e) {
      e.preventDefault();
      if (draggedItem !== this) {
        const allItems = [...document.querySelectorAll('.itinerary-item')];
        const fromIndex = allItems.indexOf(draggedItem);
        const toIndex = allItems.indexOf(this);
        if (fromIndex < toIndex) this.after(draggedItem);
        else this.before(draggedItem);
      }
      draggedItem.classList.remove('dragging');
      saveData();
    }

    function saveData() {
      if (!currentRoom) return;
      const data = { /* 所有欄位 + itineraryHTML: document.getElementById('itineraryList').innerHTML */ };
      // 完整 saveData 請保留你原本的邏輯
    }

    function show(id) {
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
      document.querySelector(`nav a[onclick="show('${id}')"]`).classList.add('active');
    }
  </script>
</body>
</html>
