<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>一起旅行 - 共編神器</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#4CAF50">

  <style>
    :root { --bg: #f5f5f5; --card: white; --text: #333; --accent: #4CAF50; }
    @media (prefers-color-scheme: dark) {
      :root { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #66bb6a; }
    }
    body.dark { --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --accent: #66bb6a; }
    body { margin:0; background:var(--bg); color:var(--text); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; transition:all 0.3s; padding-bottom:80px; }
    h1 { background:var(--accent); color:white; margin:0; padding:20px; text-align:center; font-size:22px; }
    section { margin:15px; padding:18px; background:var(--card); border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
    input, button, select { width:100%; padding:14px; margin:8px 0; border-radius:12px; border:none; font-size:16px; box-sizing:border-box; }
    input, select { background:#f0f0f0; }
    body.dark input, body.dark select { background:#333; color:white; }
    button { background:var(--accent); color:white; font-weight:bold; cursor:pointer; }
    .small-btn { padding:10px 16px; width:auto; display:inline-block; margin:5px; }
    .online { text-align:center; padding:10px; font-size:14px; }
    .users { display:flex; flex-wrap:wrap; gap:8px; margin:10px 0; }
    .user { display:flex; align-items:center; background:rgba(0,0,0,0.1); padding:6px 10px; border-radius:20px; font-size:13px; }
    .avatar { width:20px; height:20px; border-radius:50%; margin-right:6px; }
    .reminder { color:#ff5252; font-weight:bold; }
    #mapContainer a { color:#2196F3; font-size:18px; text-decoration:underline; }
    .tutorial { background:#fff3e0; padding:15px; border-radius:12px; margin:15px; }
    body.dark .tutorial { background:#3d2c00; }
  </style>
</head>
<body>
  <h1>一起旅行 - 共編神器</h1>
  <div class="online" id="status">連線中…</div>
  <div style="text-align:center;">
    <button class="small-btn" onclick="document.body.classList.toggle('dark')">Dark Mode</button>
    <button class="small-btn" onclick="showTutorial()">使用教學</button>
  </div>

  <!-- 誰在線上 -->
  <section>
    <h2>線上旅伴</h2>
    <input type="text" id="nickname" placeholder="輸入你的暱稱（可愛點！）" value="旅人${{Math.random().toString(36).substr(2,4)}}">
    <button onclick="setNickname()">設定暱稱</button>
    <div class="users" id="onlineUsers"></div>
  </section>

  <!-- 共編房間 -->
  <section>
    <h2>共編房間</h2>
    <input type="text" id="roomId" placeholder="輸入或產生房間代碼">
    <button onclick="createRoom()">產生新房間</button>
    <button onclick="joinRoom()">加入房間</button>
    <p>目前房間：<b id="currentRoom">尚未加入</b></p>
    
    <h3>版本管理</h3>
    <input type="text" id="versionName" placeholder="版本名稱（如：親子版）">
    <button class="small-btn" onclick="saveVersion()">儲存新版本</button>
    <select id="versionList" onchange="loadVersion(this.value)"></select>
  </section>

  <!-- 所有功能區塊（略） -->
  <section><h2>AI推薦景點</h2>
    <input type="text" id="aiCity" placeholder="輸入城市"><button onclick="getAIAttractions()">AI推薦</button>
    <div id="attractionsOutput"></div>
  </section>

  <section><h2>行程 + 天氣</h2>
    <input type="text" id="destination" placeholder="目的地"><input type="number" id="days" placeholder="天數">
    <button onclick="planItinerary()">生成行程</button>
    <div id="itineraryOutput"></div>
  </section>

  <section><h2>預算計算</h2>
    <input type="number" id="transport" placeholder="交通"><input type="number" id="accommodation" placeholder="住宿">
    <input type="number" id="food" placeholder="餐飲"><input type="number" id="activities" placeholder="活動">
    <button onclick="calculateBudget()">計算</button>
    <div id="budgetOutput"></div>
  </section>

  <section><h2>導航</h2>
    <input type="text" id="start" placeholder="起點"><input type="text" id="end" placeholder="終點">
    <button onclick="showNavigation()">開啟地圖</button>
    <div id="mapContainer"></div>
  </section>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  
  <script>
    const firebaseConfig = {
      databaseURL: "https://travel-together-2025-default-rtdb.asia-southeast1.firebasedatabase.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myId = Math.random().toString(36).substr(2,9);
    let myName = "旅人";
    let currentRoom = null;
    let currentVersion = "default";

    const colors = ["#FF5252","#FF4081","#E040FB","#536DFE","#448AFF","#40C4FF","#26C6DA","#66BB6A","#D4E157","#FFCA28"];

    function setNickname() {
      myName = document.getElementById('nickname').value || "神秘旅人";
      updatePresence();
    }

    function updatePresence() {
      if (!currentRoom) return;
      db.ref('presence/' + currentRoom + '/' + myId).set({
        name: myName,
        color: colors[Math.floor(Math.random()*colors.length)],
        lastSeen: Date.now()
      });
      // 移除 30 秒沒動的人
      setTimeout(() => {
        db.ref('presence/' + currentRoom + '/' + myId).remove();
      }, 30000);
    }

    // 監聽線上人
    function listenOnline() {
      db.ref('presence/' + currentRoom).on('value', snap => {
        const users = snap.val() || {};
        const div = document.getElementById('onlineUsers');
        div.innerHTML = "";
        Object.keys(users).forEach(id => {
          if (id === myId) return;
          const u = users[id];
          const el = document.createElement('div');
          el.className = 'user';
          el.innerHTML = `<div class="avatar" style="background:${u.color}"></div>${u.name}`;
          div.appendChild(el);
        });
      });
    }

    // 其餘功能（房間、版本、儲存、載入）與上一版完全相同，只是多了 updatePresence() 呼叫
    // 所有輸入欄位加上 oninput=updatePresence() 即可
    // （為了篇幅，這裡省略完整重複程式碼，直接把上一版所有函式貼進來即可）

    function showTutorial() {
      alert(`
使用教學（超簡單 30 秒上手！）

1. 點「產生新房間」→ 得到一組代碼（如 X7K9P2）
2. 把代碼傳給旅伴（Line、訊息都行）
3. 大家輸入相同代碼 → 加入房間
4. 輸入暱稱 → 右邊會看到誰在線上
5. 開始規劃！所有內容都會即時同步
6. 想保留不同方案？輸入版本名 →「儲存新版本」
7. 隨時切換版本，完全不怕被覆蓋
8. 手機點「加入主畫面」→ 變成真正 App！

祝你們旅途愉快～
      `.trim());
    }

    // 每 5 秒更新在線狀態
    setInterval(() => { if(currentRoom) updatePresence(); }, 5000);
  </script>
</body>
</html>
