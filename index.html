<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸€èµ·æ—…è¡Œ</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#8B7E6A">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#FAF9F6;--card:#FFFFFF;--accent:#8B7E6A;--text:#333333;--soft:#B8A89A}
    body.dark{--bg:#1a1a1a;--card:#252525;--accent:#D4C2A9;--text:#E8E8E8;--soft:#A89A8B}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:'Noto Serif TC',serif;font-size:16px;line-height:1.8;min-height:100vh;transition:0.4s}
    header{background:var(--accent);color:white;padding:18px 15px;text-align:center;position:fixed;width:100%;top:0;z-index:1000;box-shadow:0 4px 20px rgba(0,0,0,0.1)}
    header h1{font-family:'ZCOOL XiaoWei',serif;font-size:28px;letter-spacing:2px}
    .moon{position:absolute;top:20px;right:20px;font-size:22px;cursor:pointer;opacity:0.9}
    main{padding-top:100px;padding-bottom:60px;max-width:900px;margin:0 auto;padding-left:15px;padding-right:15px}
    .card{background:var(--card);padding:32px;margin:20px 0;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,0.1)}
    h2{font-family:'ZCOOL XiaoWei',serif;color:var(--accent);font-size:26px;text-align:center;margin-bottom:25px}
    h3{font-size:20px;color:var(--accent);margin:20px 0 10px}
    .day-card{margin:25px 0;padding:20px;background:#f9f9f9;border-radius:14px}
    body.dark .day-card{background:#333}
    .category{padding:14px;margin:10px 0;border-left:5px solid var(--accent);background:white;border-radius:10px}
    body.dark .category{background:#444}
    .nav-btn{background:var(--accent);color:white;padding:8px 16px;border-radius:8px;text-decoration:none;margin:5px;font-size:14px;display:inline-block}
    .weather{background:var(--soft);color:white;padding:10px;border-radius:8px;margin-bottom:15px;text-align:center}
    .highlight{font-weight:bold;padding:3px 8px;border-radius:4px;margin:2px;font-size:14px}
    .must-eat{background:#4caf50;color:white}
    .must-buy{background:#ff9800;color:white}
    .reservation{background:#f44336;color:white}
    .tip{margin:20px 0;padding:18px;background:#f0f0f0;border-radius:14px;font-size:15px}
    body.dark .tip{background:#333}
    .room-code{font-size:36px;font-weight:bold;color:var(--accent);letter-spacing:8px;margin:25px 0;text-align:center}
    .online{text-align:center;margin:15px 0;font-size:14px;color:var(--soft)}
    input,button,select{width:100%;padding:14px;margin:8px 0;border:none;border-radius:12px;font-size:16px}
    input,select{background:#f5f5f5}
    body.dark input,body.dark select{background:#333;color:white}
    button{background:var(--accent);color:white;font-weight:600;cursor:pointer}
    button:hover{background:var(--soft)}
    .btn-small{padding:12px 24px;width:auto;display:inline-block;margin:6px;font-size:15px;border-radius:20px}
    .currency-grid{display:grid;grid-template-columns:2fr 1fr;gap:10px;align-items:center}
    #finalTotal{font-size:24px;font-weight:bold;text-align:center;margin:20px 0;padding:15px;background:#4caf50;color:white;border-radius:12px}
    #tools{background:var(--soft);padding:20px;border-radius:12px;margin:20px 0}
    .tool-item{margin:10px 0}
  </style>
</head>
<body>

<header>
  <h1>ä¸€èµ·æ—…è¡Œ</h1>
  <div class="moon" onclick="document.body.classList.toggle('dark')">ğŸŒ™</div>
</header>

<main>
  <div class="card">
    <!-- æ­¡è¿æ•™å­¸ -->
    <h2>æ­¡è¿ä¾†åˆ°ä¸€èµ·æ—…è¡Œ</h2>
    <p style="text-align:center;font-size:18px;margin-bottom:30px">ä½ çš„æ—¥æœ¬è‡ªé§•å…±ç·¨ç¥å™¨ï¼Œæ”¯æ´å¤šäººå³æ™‚ç·¨è¼¯</p>
    
    <div class="tip">
      <strong>åŠŸèƒ½ä¸€è¦½ï¼š</strong><br>
      â€¢ æ¯æ—¥è¡Œç¨‹è‡ªå‹•åˆ†é¡ï¼ˆæ™¯é»ï¼é¤å»³ï¼äº¤é€šï¼‰<br>
      â€¢ æ¯å¼µå¡ç‰‡éƒ½æœ‰å°èˆªã€å¤©æ°£ã€å¿…åƒå¿…è²·æ”»ç•¥<br>
      â€¢ æ”¯æ´æ¸¯å¹£ãƒ»æ—¥åœ“ãƒ»å°å¹£ä¸‰ç¨®è²¨å¹£è¨˜å¸³<br>
      â€¢ ç¸½é ç®—è‡ªå‹•æ›ç®—æˆã€Œæ¸¯å¹£ã€çµç®—<br>
      â€¢ èˆªç­ã€ä½å®¿ã€ç·Šæ€¥é›»è©±ä¸€æ¬¡æå®š<br>
      â€¢ åˆ†äº«ä»£ç¢¼çµ¦æœ‹å‹ï¼Œä¸€èµ·å³æ™‚å…±ç·¨
    </div>
    
    <div style="text-align:center;margin:30px 0">
      <button onclick="generateSampleItinerary()">ç”¢ç”Ÿç¯„ä¾‹æ—¥æœ¬è‡ªé§•è¡Œç¨‹</button>
    </div>

    <!-- å…±ç·¨è³‡è¨Š -->
    <div id="shareSection" style="display:none;text-align:center;margin:30px 0">
      <h3>é‚€è«‹æœ‹å‹ä¸€èµ·ç·¨è¼¯</h3>
      <div class="room-code" id="shareCode">ç”¢ç”Ÿä¸­...</div>
      <p class="online">ç›®å‰ <span id="onlineCount">1</span> äººç·šä¸Š</p>
    </div>

    <!-- è¡Œç¨‹é¡¯ç¤ºå€ -->
    <div id="itineraryCards"></div>

    <!-- æ—…è¡Œå·¥å…·å€ -->
    <div id="tools">
      <h3>æ—…è¡Œå·¥å…·</h3>
      
      <div class="tool-item">
        <h4>èˆªç­è³‡è¨Š</h4>
        <input type="text" id="flightInfo" placeholder="ä¾‹ï¼šCX520 2026-03-15 09:00" oninput="saveTool('flight',this.value)">
      </div>
      
      <div class="tool-item">
        <h4>ä½å®¿è³‡è¨Š</h4>
        <input type="text" id="hotelInfo" placeholder="ä¾‹ï¼šæ±äº¬æ–°å®¿æ ¼æ‹‰æ–¯éº—é…’åº—" oninput="saveTool('hotel',this.value)">
      </div>
      
      <div class="tool-item">
        <h4>ç·Šæ€¥è¯çµ¡é›»è©±</h4>
        <input type="text" id="emergencyInfo" placeholder="ä¾‹ï¼šå°ç£é§æ—¥ä»£è¡¨è™• +81-3-3280-7800" oninput="saveTool('emergency',this.value)">
      </div>

      <!-- å¤šå¹£ç¨®è¨˜å¸³ï¼ˆç¸½çµæ¸¯å¹£ï¼‰ -->
      <div class="tool-item">
        <h4>è¨˜å¸³ï¼é ç®—è¡¨ï¼ˆæœ€çµ‚çµç®—ç‚ºæ¸¯å¹£ï¼‰</h4>
        <div class="currency-grid">
          <input type="number" id="hkd" placeholder="æ¸¯å¹£ HKD" oninput="calcBudget()">
          <select id="currencyHKD" onchange="switchCurrency('hkd')"><option>HKD</option></select>
        </div>
        <div class="currency-grid">
          <input type="number" id="jpy" placeholder="æ—¥åœ“ JPY" oninput="calcBudget()">
          <select id="currencyJPY" onchange="switchCurrency('jpy')"><option>JPY</option></select>
        </div>
        <div class="currency-grid">
          <input type="number" id="twd" placeholder="å°å¹£ TWD" oninput="calcBudget()">
          <select id="currencyTWD" onchange="switchCurrency('twd')"><option>TWD</option></select>
        </div>
        
        <div id="finalTotal">ç¸½èŠ±è²»ï¼š0 HKD</div>
      </div>
    </div>
  </div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = { databaseURL: "https://travel-together-2025-default-rtdb.asia-southeast1.firebasedatabase.app" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const roomRef = db.ref('together-travel/main');

  // åŒ¯ç‡ (2025-11-24 å³æ™‚, 1 HKD = ç´„ 19.6 JPY, 1 HKD = ç´„ 4.11 TWD)
  const rates = { HKD: 1, JPY: 19.6, TWD: 4.11 };

  // ç¯„ä¾‹æ—¥æœ¬è‡ªé§•è¡Œç¨‹
  const sampleItinerary = [
    {day:1,loc:"æ±äº¬",cat:"æ™¯é»",title:"æ·ºè‰å¯º",story:"æ±äº¬æœ€å¤è€å¯ºå»Ÿï¼Œé›·é–€è¶…å¥½æ‹",mustEat:"äººå½¢ç‡’",mustBuy:"æ‹›è²¡è²“",res:""},
    {day:1,loc:"æ±äº¬",cat:"é¤å»³",title:"å£½å–œç‡’è€åº—",story:"A5å’Œç‰›å£½å–œç‡’",mustEat:"å£½å–œç‡’å¥—é¤",mustBuy:"",res:"éœ€é ç´„"},
    {day:1,loc:"æ±äº¬",cat:"äº¤é€š",title:"è‡ªé§•è‡³ç®±æ ¹",story:"ç¶“æ±åé«˜é€Ÿ",mustEat:"",mustBuy:"",res:""},
    {day:2,loc:"ç®±æ ¹",cat:"æ™¯é»",title:"å¤§æ¶Œè°·",story:"æ´»ç«å±±åœ°å¸¶ï¼Œåƒé»‘è›‹å¢å£½ä¸ƒå¹´",mustEat:"é»‘ç‰å­",mustBuy:"æº«æ³‰é¥…é ­",res:""},
    {day:2,loc:"ç®±æ ¹",cat:"é¤å»³",title:"æº«æ³‰æ‡·çŸ³",story:"ç®±æ ¹ç‰¹è‰²æ–™ç†",mustEat:"æ²³é®®åˆºèº«",mustBuy:"",res:""},
    {day:2,loc:"ç®±æ ¹",cat:"äº¤é€š",title:"è‡ªé§•è‡³å¯Œå£«å±±",story:"æ¹–ç•”æ™¯è§€è·¯",mustEat:"",mustBuy:"",res:""},
    {day:3,loc:"å¯Œå£«å±±",cat:"æ™¯é»",title:"æ²³å£æ¹–",story:"æœ€ç¾å¯Œå£«å±±å€’å½±",mustEat:"ã»ã†ã¨ã†éºµ",mustBuy:"å¯Œå£«å±±é¤…ä¹¾",res:""},
    {day:3,loc:"å¯Œå£«å±±",cat:"é¤å»³",title:"ã»ã†ã¨ã†å°ˆé–€åº—",story:"å±±æ¢¨å‚³çµ±éºµé£Ÿ",mustEat:"ã»ã†ã¨ã†å¥—é¤",mustBuy:"",res:""},
    {day:3,loc:"å¯Œå£«å±±",cat:"äº¤é€š",title:"è‡ªé§•è‡³äº¬éƒ½",story:"ä¸­éƒ¨æ©«æ–·é“",mustEat:"",mustBuy:"",res:""},
    {day:4,loc:"äº¬éƒ½",cat:"æ™¯é»",title:"é‡‘é–£å¯º",story:"é‡‘ç®”è¦†è“‹çš„ç¦ªå¯º",mustEat:"å…«æ©‹é¤…",mustBuy:"å’Œå‚˜",res:"ç·šä¸Šé ç´„"},
    {day:4,loc:"äº¬éƒ½",cat:"é¤å»³",title:"æ‡·çŸ³æ–™ç†",story:"äº¬éƒ½å¤šé“èœ",mustEat:"å­£ç¯€æ‡·çŸ³",mustBuy:"",res:"éœ€é ç´„"},
    {day:4,loc:"äº¬éƒ½",cat:"äº¤é€š",title:"å¸‚å…§è‡ªé§•",story:"å¤éƒ½å°è·¯",mustEat:"",mustBuy:"",res:""},
    {day:5,loc:"å¤§é˜ª",cat:"æ™¯é»",title:"å¤§é˜ªåŸ",story:"æ­·å²å ¡å£˜èŠ±åœ’",mustEat:"ç« é­šç‡’",mustBuy:"å¥‡å¹»KitKat",res:""},
    {day:5,loc:"å¤§é˜ª",cat:"é¤å»³",title:"å¤§é˜ªç‡’",story:"éµæ¿æ–™ç†",mustEat:"å»£å³¶é¢¨å¤§é˜ªç‡’",mustBuy:"",res:""},
    {day:5,loc:"å¤§é˜ª",cat:"äº¤é€š",title:"è¿”ç¨‹è‡ªé§•",story:"é«˜é€Ÿå›æ±äº¬",mustEat:"",mustBuy:"",res:""}
  ];

  function generateSampleItinerary() {
    roomRef.child('itinerary').set(sampleItinerary);
    const code = Math.random().toString(36).substring(2,8).toUpperCase();
    roomRef.child('shareCode').set(code);
    document.getElementById('shareSection').style.display = 'block';
    document.getElementById('shareCode').textContent = code;
    setupOnline();
  }

  // é¡¯ç¤ºæ¯æ—¥å¡ç‰‡
  roomRef.child('itinerary').on('value', snap => {
    const data = snap.val() || [];
    let html = '';
    const days = {};
    data.forEach(item => {
      if (!days[item.day]) days[item.day] = { loc: item.loc, weather: getWeather(item.loc), items: { æ™¯é»: [], é¤å»³: [], äº¤é€š: [] } };
      days[item.day].items[item.cat].push(item);
    });

    Object.keys(days).sort((a, b) => a - b).forEach(day => {
      const dayData = days[day];
      html += `<div class="day-card">
        <h3>ç¬¬ ${day} å¤© - ${dayData.loc} <span class="weather">${dayData.weather}</span></h3>`;
      
      ['æ™¯é»', 'é¤å»³', 'äº¤é€š'].forEach(cat => {
        if (dayData.items[cat].length > 0) {
          html += `<h4>${cat}</h4>`;
          dayData.items[cat].forEach(item => {
            html += `<div class="category">
              <strong>${item.title}</strong><br>${item.story}<br>
              ${item.mustEat ? `<span class="highlight must-eat">å¿…åƒï¼š${item.mustEat}</span>` : ''}
              ${item.mustBuy ? `<span class="highlight must-buy">å¿…è²·ï¼š${item.mustBuy}</span>` : ''}
              ${item.res ? `<span class="highlight reservation">é ç´„ï¼š${item.res}</span>` : ''}
              <a href="https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(item.title + ', ' + dayData.loc)}&travelmode=driving" class="nav-btn" target="_blank">è‡ªé§•å°èˆª</a>
            </div>`;
          });
        }
      });
      html += '</div>';
    });
    document.getElementById('itineraryCards').innerHTML = html || '<p style="text-align:center;color:#aaa;margin:40px 0">é»ä¸Šæ–¹æŒ‰éˆ•ç”¢ç”Ÿç¯„ä¾‹æ—¥æœ¬è‡ªé§•è¡Œç¨‹</p>';
  });

  function getWeather(loc) {
    const weathers = {
      'æ±äº¬': 'æ™´ 18Â°C',
      'ç®±æ ¹': 'å¤šé›² 15Â°C',
      'å¯Œå£«å±±': 'æ™´ 12Â°C',
      'äº¬éƒ½': 'é™° 16Â°C',
      'å¤§é˜ª': 'å°é›¨ 17Â°C'
    };
    return weathers[loc] || 'é æ¸¬ä¸­...';
  }

  // å·¥å…·åŒæ­¥
  ['flightInfo', 'hotelInfo', 'emergencyInfo'].forEach(id => {
    document.getElementById(id).addEventListener('input', e => {
      roomRef.child('tools/' + id.replace('Info', '')).set(e.target.value);
    });
  });

  // å¤šå¹£ç¨®è¨ˆç®—ï¼ˆç¸½çµæ¸¯å¹£ï¼‰
  function calcBudget() {
    const hkd = parseFloat(document.getElementById('hkd').value) || 0;
    const jpy = parseFloat(document.getElementById('jpy').value) || 0;
    const twd = parseFloat(document.getElementById('twd').value) || 0;
    const totalHKD = hkd + (jpy / rates.JPY) + (twd / rates.TWD);
    document.getElementById('finalTotal').textContent = `ç¸½èŠ±è²»ï¼š${totalHKD.toFixed(0)} HKD`;
    roomRef.child('budget').set({ hkd, jpy, twd, totalHKD });
  }
  ['hkd', 'jpy', 'twd'].forEach(id => document.getElementById(id).addEventListener('input', calcBudget));

  // è¼‰å…¥é ç®—
  roomRef.child('budget').on('value', snap => {
    const b = snap.val();
    if (b) {
      document.getElementById('hkd').value = b.hkd || '';
      document.getElementById('jpy').value = b.jpy || '';
      document.getElementById('twd').value = b.twd || '';
      calcBudget();
    }
  });

  // å…±ç·¨åœ¨ç·š
  function setupOnline() {
    const onlineRef = roomRef.child('online').push();
    onlineRef.set(Date.now());
    onlineRef.onDisconnect().remove();
    roomRef.child('online').on('value', snap => {
      const users = snap.val() || {};
      const count = Object.keys(users).length;
      document.getElementById('onlineCount').textContent = count;
    });
  }

  window.onload = () => {
    document.getElementById('itineraryCards').innerHTML = '<p style="text-align:center;color:#aaa;margin:40px 0">æ­¡è¿ï¼é»ã€Œç”¢ç”Ÿç¯„ä¾‹æ—¥æœ¬è‡ªé§•è¡Œç¨‹ã€é–‹å§‹è¦åŠƒå§ï½</p>';
  };
</script>
</body>
</html>
