<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>一起旅行</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#8B7E6A">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#FAF9F6;--card:#FFF;--accent:#8B7E6A;--text:#333;--soft:#B8A89A}
    body.dark{--bg:#000;--card:#1e1e1e;--accent:#D4C2A9;--text:#f0f0f0;--soft:#B89A7A}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:'Noto Serif TC',serif;font-size:16px;line-height:1.8;transition:0.3s}
    header{background:var(--accent);color:white;padding:18px;position:fixed;width:100%;top:0;z-index:1000;box-shadow:0 4px 20px rgba(0,0,0,0.15)}
    header h1{font-family:'ZCOOL XiaoWei',serif;font-size:28px;letter-spacing:3px}
    .moon{position:absolute;top:20px;right:20px;font-size:24px;cursor:pointer}
    main{padding:90px 15px 100px;max-width:900px;margin:0 auto}
    .card{background:var(--card);border-radius:22px;padding:32px;margin:20px 0;box-shadow:0 12px 35px rgba(0,0,0,0.1)}
    h2{color:var(--accent);font-size:26px;text-align:center;margin-bottom:25px}
    input,select,textarea{width:100%;padding:16px;margin:12px 0;border:none;border-radius:16px;font-size:17px;background:#f5f5f5;color:var(--text)}
    body.dark input,body.dark select{background:#333;color:#fff}
    button{background:var(--accent);color:white;padding:18px;border:none;border-radius:20px;font-size:18px;cursor:pointer;font-weight:600;margin:20px auto;display:block;width:90%}
    .google-btn{background:#4285f4;color:white;display:flex;align-items:center;justify-content:center;gap:12px}
    .profile{position:absolute;top:20px;left:20px;color:white;font-size:20px;cursor:pointer;z-index:1001}
    .dropdown{margin:15px 0}
    .dropdown select[multiple]{height:120px}
    .price-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .nights{margin-top:10px}
    .room-code{font-size:38px;letter-spacing:8px;color:var(--accent);text-align:center;margin:20px 0}
    .online{text-align:center;margin:15px 0;color:var(--soft)}
    .navbar{position:fixed;bottom:0;width:100%;background:var(--accent);display:flex;z-index:999}
    .navbar button{flex:1;padding:16px;color:white;background:transparent;border:none;font-size:13px}
    .navbar button.active{background:rgba(255,255,255,0.2)}
  </style>
</head>
<body>

<header>
  <h1>一起旅行</h1>
  <div class="moon" onclick="document.body.classList.toggle('dark')">Moon</div>
  <div class="profile" onclick="showProfile()">Profile</div>
</header>

<!-- 登入畫面 -->
<div id="loginScreen" class="card" style="text-align:center;margin-top:100px">
  <h2>歡迎來到一起旅行</h2>
  <p style="margin:30px 0;font-size:18px">多人即時共編行程神器</p>
  <button class="google-btn" onclick="googleLogin()">
    <img src="https://www.google.com/favicon.ico" width="20"> Google 登入
  </button>
  <button onclick="guestMode()" style="background:#666;margin-top:15px">訪客模式繼續</button>
</div>

<!-- 主畫面 -->
<div id="mainApp" style="display:none">
  <main>
    <!-- 建立行程表單 -->
    <div id="createTrip" class="card">
      <h2>建立新行程</h2>
      
      <div class="dropdown">
        <label>旅行國家（可多選）</label>
        <select id="countries" multiple>
          <option value="日本">日本</option>
          <option value="韓國">韓國</option>
          <option value="泰國">泰國</option>
          <option value="台灣">台灣</option>
          <option value="新加坡">新加坡</option>
          <option value="越南">越南</option>
          <option value="馬來西亞">馬來西亞</option>
          <option value="澳洲">澳洲</option>
          <option value="歐洲">歐洲（多國）</option>
        </select>
      </div>

      <div class="dropdown">
        <label>主要城市（可多選）</label>
        <select id="cities" multiple>
          <option value="東京">東京</option>
          <option value="大阪">大阪</option>
          <option value="京都">京都</option>
          <option value="箱根">箱根</option>
          <option value="富士山">富士山</option>
          <option value="首爾">首爾</option>
          <option value="曼谷">曼谷</option>
          <option value="台北">台北</option>
        </select>
      </div>

      <input type="number" id="people" placeholder="旅程人數" value="4">
      <input type="date" id="startDate">
      <input type="date" id="endDate">

      <h3>航班資訊</h3>
      <input type="text" id="flight" placeholder="去程航班編號（如 CX520）">
      <div class="price-row">
        <input type="number" placeholder="機票價格" id="flightPrice">
        <select id="flightCurrency"><option>HKD</option><option>JPY</option><option>TWD</option><option>USD</option></select>
      </div>

      <h3>住宿資訊</h3>
      <select id="accommodationType">
        <option>酒店</option>
        <option>民宿</option>
        <option>其他</option>
      </select>
      <input type="text" id="hotelName" placeholder="住宿名稱">
      <div class="price-row">
        <input type="number" id="hotelPrice" placeholder="每晚價格">
        <select id="hotelCurrency"><option>HKD</option><option>JPY</option><option>TWD</option></select>
      </div>
      <input type="number" id="nights" placeholder="入住晚數" class="nights">
      <input type="text" id="roomType" placeholder="房型（如 雙人房）">

      <h3>交通方式</h3>
      <select id="transportType">
        <option>租車自駕</option>
        <option>JR Pass</option>
        <option>地鐵/電車/高鐵</option>
        <option>包車</option>
        <option>其他</option>
      </select>
      <textarea id="transportInfo" placeholder="交通詳情（如租車公司、Pass種類、包車司機聯絡）" rows="3"></textarea>
      <div class="price-row">
        <input type="number" id="transportPrice" placeholder="交通總費用">
        <select id="transportCurrency"><option>HKD</option><option>JPY</option><option>TWD</option></select>
      </div>

      <button onclick="createNewTrip()">完成建立行程</button>
    </div>

    <!-- 行程總覽頁 -->
    <div id="tripView" style="display:none" class="card">
      <h2 id="tripTitle">日本自駕 8 日遊</h2>
      <div class="room-code" id="roomCode">------</div>
      <p class="online">目前 <span id="onlineCount">1</span> 人編輯中</p>
      <div id="itineraryCards"></div>
    </div>

    <!-- 預算頁 -->
    <div id="budgetView" style="display:none" class="card">
      <h2>行程總預算</h2>
      <div id="budgetSummary"></div>
      <div id="totalHKD" style="font-size:32px;margin:30px 0;color:#4caf50;text-align:center">總計：0 HKD</div>
      <div id="perPerson" style="font-size:24px;text-align:center;color:#666"></div>
    </div>
  </main>

  <!-- 底部導航（已修好可點）-->
  <div class="navbar">
    <button class="active" onclick="showPage('createTrip')">建立</button>
    <button onclick="showPage('tripView')">行程</button>
    <button onclick="showPage('budgetView')">預算</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
  const firebaseConfig = { databaseURL: "https://travel-together-2025-default-rtdb.asia-southeast1.firebasedatabase.app" };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  let currentUser = null;
  let currentRoom = null;
  let roomRef = null;

  // Google 登入
  function googleLogin() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).then(result => {
      currentUser = result.user;
      startApp();
    }).catch(err => alert("登入失敗：" + err.message));
  }

  function guestMode() {
    currentUser = { displayName: "訪客", uid: "guest_" + Date.now() };
    startApp();
  }

  function startApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.querySelector('.profile').textContent = currentUser.displayName[0];
  }

  function showPage(id) {
    document.querySelectorAll('#mainApp > main > div').forEach(d => d.style.display = 'none');
    document.getElementById(id).style.display = 'block';
    document.querySelectorAll('.navbar button').forEach((b,i) => b.classList.toggle('active', 
      ['createTrip','tripView','budgetView'].indexOf(id) === i));
  }

  function createNewTrip() {
    currentRoom = Math.random().toString(36).substring(2,8).toUpperCase();
    roomRef = db.ref('trips/' + currentRoom);

    const tripData = {
      info: {
        creator: currentUser.uid,
        countries: Array.from(document.getElementById('countries').selectedOptions).map(o=>o.value),
        cities: Array.from(document.getElementById('cities').selectedOptions).map(o=>o.value),
        people: document.getElementById('people').value,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        flight: document.getElementById('flight').value,
        flightPrice: document.getElementById('flightPrice').value,
        flightCurrency: document.getElementById('flightCurrency').value,
        accommodation: {
          type: document.getElementById('accommodationType').value,
          name: document.getElementById('hotelName').value,
          price: document.getElementById('hotelPrice').value,
          currency: document.getElementById('hotelCurrency').value,
          nights: document.getElementById('nights').value,
          roomType: document.getElementById('roomType').value
        },
        transport: {
          type: document.getElementById('transportType').value,
          info: document.getElementById('transportInfo').value,
          price: document.getElementById('transportPrice').value,
          currency: document.getElementById('transportCurrency').value
        }
      },
      itinerary: generateSampleItinerary(),
      budget: {hkd:0,jpy:0,twd:0}
    };

    roomRef.set(tripData).then(() => {
      document.getElementById('roomCode').textContent = currentRoom;
      document.getElementById('tripTitle').textContent = tripData.info.countries.join('・') + ' 旅行';
      showPage('tripView');
      loadItinerary();
      calculateBudget();
    });
  }

  function generateSampleItinerary() {
    return [
      {day:1,loc:"東京",cat:"景點",title:"淺草寺",story:"東京最古老寺廟",mustEat:"人形燒"},
      {day:2,loc:"箱根",cat:"景點",title:"大涌谷",story:"黑蛋增壽七年",mustEat:"黑玉子"}
    ];
  }

  function loadItinerary() {
    // 渲染行程卡片（同之前）
  }

  function calculateBudget() {
    // 自動計算總額 + 每人分擔
  }
</script>
</body>
</html>
